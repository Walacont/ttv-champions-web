rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isAdmin() {
      return isAuthenticated() && getUserData().role == 'admin';
    }

    function isCoachOrAdmin() {
      return isAuthenticated() && getUserData().role in ['coach', 'admin'];
    }

    function isSameClub(clubId) {
      return isAuthenticated() && getUserData().clubId == clubId;
    }

    function isCoachOfClub(clubId) {
      return isCoachOrAdmin() && isSameClub(clubId);
    }

    // Users collection
    match /users/{userId} {
      // Users can read their own data
      allow read: if isOwner(userId);

      // Players can read other players in their club (for leaderboard, rivals, etc.)
      allow read: if isAuthenticated() &&
        resource.data.role == 'player' &&
        isSameClub(resource.data.clubId);

      // Coaches and admins can read all users in their club
      allow read: if isCoachOrAdmin() && isSameClub(resource.data.clubId);

      // ADMIN can read ALL users (for statistics and club management)
      allow read: if isAdmin();

      // Users can update their own profile (limited fields)
      allow update: if isOwner(userId) &&
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'clubId', 'points', 'xp', 'eloRating', 'highestElo']);

      // Coaches can update players in their club (including points, xp, eloRating, etc.)
      allow update: if isCoachOrAdmin() &&
        isSameClub(resource.data.clubId) &&
        resource.data.role == 'player';

      // Coaches can create new players in their club (offline players)
      allow create: if isCoachOrAdmin() &&
        isSameClub(request.resource.data.clubId) &&
        request.resource.data.role == 'player';

      // Only admins can delete users
      allow delete: if isAdmin();

      // Subcollection: pointsHistory
      match /pointsHistory/{historyId} {
        allow read: if isOwner(userId);
        allow read: if isCoachOrAdmin();
        allow write: if isCoachOrAdmin();
      }

      // Subcollection: xpHistory
      match /xpHistory/{historyId} {
        allow read: if isOwner(userId);
        allow read: if isCoachOrAdmin();
        allow write: if isCoachOrAdmin();
      }

      // Subcollection: streaks
      match /streaks/{subgroupId} {
        allow read: if isOwner(userId);
        allow read, write: if isCoachOrAdmin();
      }

      // Subcollection: completedChallenges
      match /completedChallenges/{challengeId} {
        allow read, write: if isOwner(userId);
        allow read: if isCoachOrAdmin();
      }
    }

    // Clubs collection
    match /clubs/{clubId} {
      allow read: if isAuthenticated() && isSameClub(clubId);
      allow read: if isAdmin();
      allow write: if isCoachOfClub(clubId);
      allow write: if isAdmin();
    }

    // Subgroups collection
    match /subgroups/{subgroupId} {
      allow read: if isAuthenticated();
      allow create: if isCoachOrAdmin() && isSameClub(request.resource.data.clubId);
      allow update, delete: if isCoachOfClub(resource.data.clubId);
    }

    // Attendance collection
    match /attendance/{attendanceId} {
      allow read: if isAuthenticated();
      allow create: if isCoachOrAdmin() && isSameClub(request.resource.data.clubId);
      allow update, delete: if isCoachOrAdmin() && isSameClub(resource.data.clubId);
    }

    // Matches collection
    match /matches/{matchId} {
      allow read: if isAuthenticated();
      allow create: if isCoachOrAdmin() && isSameClub(request.resource.data.clubId);
      allow update, delete: if isCoachOfClub(resource.data.clubId);
    }

    // Challenges collection
    match /challenges/{challengeId} {
      allow read: if isAuthenticated();
      allow create: if isCoachOrAdmin() && isSameClub(request.resource.data.clubId);
      allow update, delete: if isCoachOfClub(resource.data.clubId);
    }

    // Exercises collection (global)
    match /exercises/{exerciseId} {
      allow read: if isAuthenticated();
      allow write: if isCoachOrAdmin();
    }

    // Invitations collection
    match /invitations/{invitationId} {
      allow read: if isAuthenticated() && resource.data.email == request.auth.token.email;
      allow create: if isCoachOfClub(request.resource.data.clubId);
      allow delete: if isAuthenticated() && resource.data.email == request.auth.token.email;
    }

    // Invitation Codes collection - WICHTIG: Öffentlich lesbar!
    match /invitationCodes/{codeId} {
      // Jeder kann Codes lesen (für Login-Validierung)
      allow read: if true;

      // ADMIN kann Codes für JEDEN Club erstellen
      allow create: if isAdmin();

      // Coaches können nur Codes für ihren eigenen Club erstellen
      allow create: if isCoachOrAdmin() && isSameClub(request.resource.data.clubId);

      // ADMIN kann alle Codes updaten (z.B. zum Invalidieren)
      allow update: if isAdmin();

      // Coaches können nur Codes ihres Clubs updaten (z.B. zum Invalidieren alter Codes)
      allow update: if isCoachOfClub(resource.data.clubId);

      // ADMIN kann alle Codes löschen
      allow delete: if isAdmin();

      // Coaches können nur Codes ihres Clubs löschen
      allow delete: if isCoachOfClub(resource.data.clubId);
    }

    // Invitation Tokens collection - WICHTIG: Öffentlich lesbar!
    match /invitationTokens/{tokenId} {
      allow read: if true;
      allow create: if isCoachOrAdmin();
      allow delete: if true;
    }

    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
