rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isCoachOrAdmin() {
      return isAuthenticated() && getUserData().role in ['coach', 'admin'];
    }

    function isSameClub(clubId) {
      return isAuthenticated() && getUserData().clubId == clubId;
    }

    function isCoachOfClub(clubId) {
      return isCoachOrAdmin() && isSameClub(clubId);
    }

    // Users collection
    match /users/{userId} {
      // Users can read their own data
      allow read: if isOwner(userId);

      // Players can read other players in their club (for leaderboard, rivals, etc.)
      allow read: if isAuthenticated() &&
        resource.data.role == 'player' &&
        isSameClub(resource.data.clubId);

      // Coaches and admins can read all users in their club
      allow read: if isCoachOrAdmin() && isSameClub(resource.data.clubId);

      // Users can update their own profile (limited fields)
      allow update: if isOwner(userId) &&
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'clubId', 'points', 'xp', 'eloRating', 'highestElo']);

      // Coaches can update players in their club (including points, xp, eloRating, etc.)
      allow update: if isCoachOrAdmin() &&
        isSameClub(resource.data.clubId) &&
        resource.data.role == 'player';

      // Coaches can create new players in their club
      allow create: if isCoachOrAdmin() &&
        isSameClub(request.resource.data.clubId) &&
        request.resource.data.role == 'player';

      // Only admins can delete users
      allow delete: if isAuthenticated() && getUserData().role == 'admin';

      // Subcollection: pointsHistory
      match /pointsHistory/{historyId} {
        // Users can read their own points history
        allow read: if isOwner(userId);

        // Coaches can read points history for players in their club
        allow read: if isCoachOrAdmin();

        // Coaches can write points history
        allow write: if isCoachOrAdmin();
      }

      // Subcollection: xpHistory (NEW for rank system)
      match /xpHistory/{historyId} {
        // Users can read their own XP history
        allow read: if isOwner(userId);

        // Coaches can read XP history for players in their club
        allow read: if isCoachOrAdmin();

        // Coaches can write XP history
        allow write: if isCoachOrAdmin();
      }

      // Subcollection: streaks (NEW for subgroups feature)
      match /streaks/{subgroupId} {
        // Users can read their own streaks
        allow read: if isOwner(userId);

        // Coaches can read/write streaks for players in their club
        allow read, write: if isCoachOrAdmin();
      }

      // Subcollection: completedChallenges
      match /completedChallenges/{challengeId} {
        // Users can read and write their own completed challenges
        allow read, write: if isOwner(userId);

        // Coaches can read completed challenges for players in their club
        allow read: if isCoachOrAdmin();
      }
    }

    // Clubs collection
    match /clubs/{clubId} {
      allow read: if isAuthenticated() && isSameClub(clubId);
      allow write: if isCoachOfClub(clubId);
    }

    // Subgroups collection (NEW for subgroups feature)
    match /subgroups/{subgroupId} {
      // Anyone authenticated can read subgroups (filtered by client code)
      allow read: if isAuthenticated();

      // Coaches can create/update/delete subgroups for their club
      allow create: if isCoachOrAdmin() && isSameClub(request.resource.data.clubId);
      allow update, delete: if isCoachOfClub(resource.data.clubId);
    }

    // Attendance collection
    match /attendance/{attendanceId} {
      // Anyone authenticated can read attendance (filtered by client code)
      allow read: if isAuthenticated();

      // Coaches can create attendance for their club
      allow create: if isCoachOrAdmin() && isSameClub(request.resource.data.clubId);

      // Coaches can update/delete attendance for their club
      allow update, delete: if isCoachOrAdmin() && isSameClub(resource.data.clubId);
    }

    // Matches collection
    match /matches/{matchId} {
      // Anyone authenticated can read matches (filtered by client code)
      allow read: if isAuthenticated();

      // Coaches can create matches for their club
      allow create: if isCoachOrAdmin() && isSameClub(request.resource.data.clubId);

      // Coaches can update/delete matches for their club
      allow update, delete: if isCoachOfClub(resource.data.clubId);
    }

    // Challenges collection
    match /challenges/{challengeId} {
      // Anyone can read challenges
      allow read: if isAuthenticated();

      // Coaches can create challenges for their club
      allow create: if isCoachOrAdmin() && isSameClub(request.resource.data.clubId);

      // Coaches can update/delete challenges for their club
      allow update, delete: if isCoachOfClub(resource.data.clubId);
    }

    // Exercises collection (global)
    match /exercises/{exerciseId} {
      // Anyone can read exercises
      allow read: if isAuthenticated();

      // Only coaches and admins can write exercises
      allow write: if isCoachOrAdmin();
    }

    // Invitations collection
    match /invitations/{invitationId} {
      // Users can read their own invitations
      allow read: if isAuthenticated() && resource.data.email == request.auth.token.email;

      // Coaches can create invitations for their club
      allow create: if isCoachOfClub(request.resource.data.clubId);

      // Users can delete their own invitations (after accepting)
      allow delete: if isAuthenticated() && resource.data.email == request.auth.token.email;
    }

    // Invitation Codes collection (NEW for code-based registration)
    match /invitationCodes/{codeId} {
      // Anyone authenticated can read codes (for validation on login/registration)
      allow read: if isAuthenticated();

      // Coaches can create codes for their club
      allow create: if isCoachOrAdmin() && isSameClub(request.resource.data.clubId);

      // Coaches can update codes (e.g., mark as used) for their club
      allow update: if isCoachOfClub(resource.data.clubId);

      // Coaches can delete codes for their club
      allow delete: if isCoachOfClub(resource.data.clubId);
    }

    // Invitation Tokens collection (email-based invitations)
    match /invitationTokens/{tokenId} {
      // Anyone can read tokens (for validation)
      allow read: if true;

      // Coaches can create tokens for their club
      allow create: if isCoachOrAdmin();

      // System can update tokens (mark as used)
      allow update: if true;

      // System can delete expired tokens
      allow delete: if true;
    }

    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
