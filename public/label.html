<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Labeling - SC Champions Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .time-input::-webkit-inner-spin-button,
        .time-input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .shot-item:hover .delete-shot {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-indigo-600 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fas fa-robot text-2xl"></i>
                <div>
                    <h1 class="text-xl font-bold">Video Labeling</h1>
                    <p class="text-indigo-200 text-sm">ML-Training Daten vorbereiten</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div id="stats" class="text-sm text-indigo-200">
                    <span id="pending-count">0</span> Videos warten
                </div>
                <a href="coach.html" class="text-indigo-200 hover:text-white">
                    <i class="fas fa-arrow-left mr-1"></i>Zur√ºck
                </a>
            </div>
        </div>
    </header>

    <!-- Statistik-Leiste -->
    <div class="bg-white border-b shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex flex-wrap items-center justify-between gap-4 text-sm">
                <div class="flex flex-wrap items-center gap-4">
                    <span class="text-gray-600 font-medium">Gelabelte Videos:</span>
                    <div class="flex flex-wrap gap-3">
                        <span class="inline-flex items-center gap-1 px-2 py-1 bg-yellow-100 text-yellow-800 rounded">
                            üéæ Balleimer: <strong id="stat-ballmaschine">0</strong>
                        </span>
                        <span class="inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-800 rounded">
                            üèì Spiel: <strong id="stat-match">0</strong>
                        </span>
                        <span class="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-800 rounded">
                            üìã √úbung: <strong id="stat-exercise">0</strong>
                        </span>
                        <span class="inline-flex items-center gap-1 px-2 py-1 bg-purple-100 text-purple-800 rounded">
                            üéØ Freies Training: <strong id="stat-freeplay">0</strong>
                        </span>
                        <span class="inline-flex items-center gap-1 px-2 py-1 bg-gray-100 text-gray-800 rounded">
                            üìä Gesamt: <strong id="stat-total">0</strong>
                        </span>
                    </div>
                </div>
                <!-- Export Buttons -->
                <div class="flex gap-2">
                    <button id="export-csv-btn" class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white text-xs rounded-lg flex items-center gap-1">
                        <i class="fas fa-file-csv"></i> CSV Export
                    </button>
                    <button id="export-json-btn" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded-lg flex items-center gap-1">
                        <i class="fas fa-file-code"></i> JSON Export
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto p-4">
        <!-- Video Feed (wenn kein Video ausgew√§hlt) -->
        <div id="video-feed" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Videos werden hier dynamisch eingef√ºgt -->
            <div class="col-span-full text-center py-12 text-gray-500">
                <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                <p>Videos werden geladen...</p>
            </div>
        </div>

        <!-- Labeling Interface (wenn Video ausgew√§hlt) -->
        <div id="labeling-interface" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Links: Video -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="bg-gray-900 p-2 flex justify-between items-center">
                            <button id="back-to-feed" class="text-white hover:text-gray-300 px-3 py-1 text-sm">
                                <i class="fas fa-arrow-left mr-1"></i>Zur√ºck zur Liste
                            </button>
                            <span id="video-title" class="text-white text-sm truncate"></span>
                            <div class="text-gray-400 text-sm">
                                <span id="current-time">0:00</span> / <span id="total-time">0:00</span>
                            </div>
                        </div>
                        <video id="label-video" class="w-full bg-black" controls>
                            <source src="" type="video/mp4">
                        </video>

                        <!-- Zeitleiste mit Markierungen -->
                        <div class="p-4 bg-gray-50 border-t">
                            <div class="relative h-8 bg-gray-200 rounded-full overflow-hidden cursor-pointer" id="timeline">
                                <!-- Shot-Markierungen werden hier eingef√ºgt -->
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>0:00</span>
                                <span id="timeline-end">0:00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Coach-Kommentare -->
                    <div class="bg-white rounded-xl shadow-lg mt-4 p-4">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-comments text-indigo-500"></i>
                            Coach-Kommentare
                        </h3>
                        <div id="coach-comments" class="space-y-2 max-h-48 overflow-y-auto">
                            <!-- Kommentare werden hier eingef√ºgt -->
                        </div>
                    </div>
                </div>

                <!-- Rechts: Labeling Form -->
                <div class="space-y-4">
                    <!-- Video-Info Panel -->
                    <div class="bg-white rounded-xl shadow-lg p-4">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-info-circle text-blue-500"></i>
                            Video-Info
                        </h3>

                        <!-- Video-Typ -->
                        <div class="mb-3">
                            <label class="text-xs text-gray-600 block mb-1">Video-Typ</label>
                            <div class="flex flex-wrap gap-1">
                                <button type="button" data-vtype="ballmaschine"
                                        class="vtype-btn px-2 py-1 text-xs rounded border border-gray-300 bg-white hover:bg-blue-50 transition-colors">
                                    üéæ Balleimer
                                </button>
                                <button type="button" data-vtype="match"
                                        class="vtype-btn px-2 py-1 text-xs rounded border border-gray-300 bg-white hover:bg-blue-50 transition-colors">
                                    üèì Spiel
                                </button>
                                <button type="button" data-vtype="exercise"
                                        class="vtype-btn px-2 py-1 text-xs rounded border border-gray-300 bg-white hover:bg-blue-50 transition-colors">
                                    üìã √úbung
                                </button>
                                <button type="button" data-vtype="freeplay"
                                        class="vtype-btn px-2 py-1 text-xs rounded border border-gray-300 bg-white hover:bg-blue-50 transition-colors">
                                    üéØ Freies Training
                                </button>
                            </div>
                        </div>

                        <!-- √úbungs-Auswahl (nur wenn video_type = exercise) -->
                        <div id="exercise-selection" class="mb-3 hidden">
                            <label class="text-xs text-gray-600 block mb-1">√úbung aus Datenbank</label>
                            <select id="exercise-select" class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded">
                                <option value="">-- √úbung ausw√§hlen --</option>
                            </select>
                        </div>

                        <!-- Info wenn vom Upload bereits gesetzt -->
                        <div id="upload-info" class="hidden">
                            <div class="bg-blue-50 rounded-lg p-2 text-xs">
                                <p class="font-medium text-blue-800 mb-1">
                                    <i class="fas fa-check-circle mr-1"></i>Vom Upload festgelegt:
                                </p>
                                <p id="upload-exercise-name" class="text-blue-700"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Neuen Schlag hinzuf√ºgen -->
                    <div class="bg-white rounded-xl shadow-lg p-4">
                        <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-plus-circle text-green-500"></i>
                            Schlag markieren
                        </h3>

                        <!-- Zeit-Eingabe (mit Millisekunden) -->
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div>
                                <label class="text-xs text-gray-600 block mb-1">Start</label>
                                <div class="flex items-center gap-1">
                                    <input type="number" id="shot-start-min" min="0" max="59" value="0"
                                           class="time-input w-10 px-1 py-2 border border-gray-300 rounded text-center text-sm">
                                    <span>:</span>
                                    <input type="number" id="shot-start-sec" min="0" max="59" value="0"
                                           class="time-input w-10 px-1 py-2 border border-gray-300 rounded text-center text-sm">
                                    <span>.</span>
                                    <input type="number" id="shot-start-ms" min="0" max="999" value="0"
                                           class="time-input w-12 px-1 py-2 border border-gray-300 rounded text-center text-sm" placeholder="ms">
                                    <button id="set-start-current" class="px-2 py-2 bg-gray-100 hover:bg-gray-200 rounded text-xs" title="Aktuelle Position">
                                        <i class="fas fa-crosshairs"></i>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-600 block mb-1">Ende</label>
                                <div class="flex items-center gap-1">
                                    <input type="number" id="shot-end-min" min="0" max="59" value="0"
                                           class="time-input w-10 px-1 py-2 border border-gray-300 rounded text-center text-sm">
                                    <span>:</span>
                                    <input type="number" id="shot-end-sec" min="0" max="59" value="0"
                                           class="time-input w-10 px-1 py-2 border border-gray-300 rounded text-center text-sm">
                                    <span>.</span>
                                    <input type="number" id="shot-end-ms" min="0" max="999" value="0"
                                           class="time-input w-12 px-1 py-2 border border-gray-300 rounded text-center text-sm" placeholder="ms">
                                    <button id="set-end-current" class="px-2 py-2 bg-gray-100 hover:bg-gray-200 rounded text-xs" title="Aktuelle Position">
                                        <i class="fas fa-crosshairs"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Position: Von wo / Nach wo -->
                        <div class="mb-4 grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs text-gray-600 block mb-1">Von (Spieler)</label>
                                <div class="flex rounded-lg border border-gray-300 overflow-hidden">
                                    <button type="button" data-from="vh"
                                            class="from-btn flex-1 px-2 py-2 text-xs bg-white hover:bg-indigo-50 transition-colors">
                                        VH
                                    </button>
                                    <button type="button" data-from="mitte"
                                            class="from-btn flex-1 px-2 py-2 text-xs bg-white hover:bg-gray-50 transition-colors border-l">
                                        Mitte
                                    </button>
                                    <button type="button" data-from="rh"
                                            class="from-btn flex-1 px-2 py-2 text-xs bg-white hover:bg-purple-50 transition-colors border-l">
                                        RH
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-600 block mb-1">Nach (Gegner)</label>
                                <div class="flex rounded-lg border border-gray-300 overflow-hidden">
                                    <button type="button" data-to="vh"
                                            class="to-btn flex-1 px-2 py-2 text-xs bg-white hover:bg-indigo-50 transition-colors">
                                        VH
                                    </button>
                                    <button type="button" data-to="mitte"
                                            class="to-btn flex-1 px-2 py-2 text-xs bg-white hover:bg-gray-50 transition-colors border-l">
                                        Mitte
                                    </button>
                                    <button type="button" data-to="rh"
                                            class="to-btn flex-1 px-2 py-2 text-xs bg-white hover:bg-purple-50 transition-colors border-l">
                                        RH
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Schlagtyp -->
                        <div class="mb-4">
                            <label class="text-xs text-gray-600 block mb-1">Schlagtyp</label>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <p class="text-xs text-indigo-600 font-medium mb-1">Vorhand</p>
                                    <div class="space-y-1">
                                        <button class="shot-type-btn w-full px-2 py-1.5 text-xs border border-gray-300 rounded hover:border-indigo-500 text-left" data-type="forehand_serve">
                                            VH Aufschlag
                                        </button>
                                        <button class="shot-type-btn w-full px-2 py-1.5 text-xs border border-gray-300 rounded hover:border-indigo-500 text-left" data-type="forehand_topspin">
                                            VH Topspin
                                        </button>
                                        <button class="shot-type-btn w-full px-2 py-1.5 text-xs border border-gray-300 rounded hover:border-indigo-500 text-left" data-type="forehand_push">
                                            VH Schupf
                                        </button>
                                        <button class="shot-type-btn w-full px-2 py-1.5 text-xs border border-gray-300 rounded hover:border-indigo-500 text-left" data-type="forehand_block">
                                            VH Block
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-xs text-purple-600 font-medium mb-1">R√ºckhand</p>
                                    <div class="space-y-1">
                                        <button class="shot-type-btn w-full px-2 py-1.5 text-xs border border-gray-300 rounded hover:border-purple-500 text-left" data-type="backhand_serve">
                                            RH Aufschlag
                                        </button>
                                        <button class="shot-type-btn w-full px-2 py-1.5 text-xs border border-gray-300 rounded hover:border-purple-500 text-left" data-type="backhand_topspin">
                                            RH Topspin
                                        </button>
                                        <button class="shot-type-btn w-full px-2 py-1.5 text-xs border border-gray-300 rounded hover:border-purple-500 text-left" data-type="backhand_push">
                                            RH Schupf
                                        </button>
                                        <button class="shot-type-btn w-full px-2 py-1.5 text-xs border border-gray-300 rounded hover:border-purple-500 text-left" data-type="backhand_block">
                                            RH Block
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Ergebnis -->
                        <div class="mb-4">
                            <label class="text-xs text-gray-600 block mb-1">Ergebnis</label>
                            <div class="flex rounded-lg border border-gray-300 overflow-hidden">
                                <button type="button" data-result="hit"
                                        class="result-btn flex-1 px-2 py-2 text-xs bg-green-600 text-white transition-colors">
                                    ‚úì Getroffen
                                </button>
                                <button type="button" data-result="net"
                                        class="result-btn flex-1 px-2 py-2 text-xs bg-white hover:bg-orange-50 transition-colors border-l">
                                    Netz
                                </button>
                                <button type="button" data-result="out"
                                        class="result-btn flex-1 px-2 py-2 text-xs bg-white hover:bg-red-50 transition-colors border-l">
                                    Aus
                                </button>
                                <button type="button" data-result="miss"
                                        class="result-btn flex-1 px-2 py-2 text-xs bg-white hover:bg-gray-100 transition-colors border-l">
                                    Verfehlt
                                </button>
                            </div>
                        </div>

                        <!-- Hinzuf√ºgen Button -->
                        <button id="add-shot-btn"
                                class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                            <i class="fas fa-plus"></i>
                            Schlag hinzuf√ºgen
                        </button>
                    </div>

                    <!-- Bereits markierte Schl√§ge -->
                    <div class="bg-white rounded-xl shadow-lg p-4">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-list text-indigo-500"></i>
                            Markierte Schl√§ge
                            <span id="shot-count" class="bg-indigo-100 text-indigo-700 text-xs px-2 py-0.5 rounded-full">0</span>
                        </h3>
                        <div id="shots-list" class="space-y-2 max-h-64 overflow-y-auto">
                            <p class="text-gray-500 text-sm text-center py-4">Noch keine Schl√§ge markiert</p>
                        </div>
                    </div>

                    <!-- Aktionen -->
                    <div class="bg-white rounded-xl shadow-lg p-4 space-y-3">
                        <button id="verify-btn"
                                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                            <i class="fas fa-check-circle"></i>
                            Verifizieren & Speichern
                        </button>
                        <button id="skip-btn"
                                class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                            <i class="fas fa-forward"></i>
                            √úberspringen (ungeeignet)
                        </button>
                    </div>

                    <!-- Keyboard Shortcuts -->
                    <div class="bg-gray-50 rounded-lg p-3 text-xs text-gray-500">
                        <p class="font-medium mb-1">Tastenk√ºrzel:</p>
                        <div class="grid grid-cols-2 gap-1">
                            <span><kbd class="bg-white px-1 rounded">Space</kbd> Play/Pause</span>
                            <span><kbd class="bg-white px-1 rounded">S</kbd> Start setzen</span>
                            <span><kbd class="bg-white px-1 rounded">E</kbd> Ende setzen</span>
                            <span><kbd class="bg-white px-1 rounded">Enter</kbd> Schlag hinzuf√ºgen</span>
                            <span><kbd class="bg-white px-1 rounded">1-8</kbd> Schlagtyp</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <script type="module">
        import { getSupabase } from './js/supabase-init.js';

        let supabase;
        let currentUser;
        let currentVideo = null;
        let currentShots = [];
        let videoPlayer;
        let exercisesList = [];
        let selectedVideoType = null;
        let selectedExerciseId = null;

        // Video type labels
        const videoTypeLabels = {
            'ballmaschine': 'üéæ Balleimer',
            'match': 'üèì Spiel',
            'exercise': 'üìã √úbung',
            'freeplay': 'üéØ Freies Training',
            'other': 'Sonstiges'
        };

        // Shot type labels for display
        const shotTypeLabels = {
            'forehand_serve': 'VH Aufschlag',
            'backhand_serve': 'RH Aufschlag',
            'forehand_topspin': 'VH Topspin',
            'backhand_topspin': 'RH Topspin',
            'forehand_push': 'VH Schupf',
            'backhand_push': 'RH Schupf',
            'forehand_block': 'VH Block',
            'backhand_block': 'RH Block',
            'other': 'Sonstige'
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            supabase = getSupabase();

            // Check auth
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                window.location.href = '/index.html';
                return;
            }
            currentUser = user;

            // Check if user is admin or labeler (only these roles can access labeling)
            const { data: profile } = await supabase
                .from('profiles')
                .select('role')
                .eq('id', user.id)
                .single();

            if (!profile || !['admin', 'labeler'].includes(profile.role)) {
                showToast('Zugriff verweigert - Nur f√ºr Admins/Labeler', 'error');
                setTimeout(() => {
                    window.location.href = '/index.html';
                }, 1500);
                return;
            }

            // Load exercises for dropdown
            await loadExercises();

            // Load statistics
            loadStats();

            // Load videos
            loadPendingVideos();

            // Setup event listeners
            setupEventListeners();
        });

        async function loadStats() {
            // Get count of labeled videos (ai_ready = true) by video_type
            const { data: stats, error } = await supabase
                .from('video_analyses')
                .select('video_type')
                .eq('ai_ready', true);

            if (error) {
                console.error('Error loading stats:', error);
                return;
            }

            // Count by type
            const counts = {
                ballmaschine: 0,
                match: 0,
                exercise: 0,
                freeplay: 0,
                other: 0,
                null: 0
            };

            (stats || []).forEach(v => {
                const type = v.video_type || 'null';
                if (counts.hasOwnProperty(type)) {
                    counts[type]++;
                } else {
                    counts.other++;
                }
            });

            // Update UI
            document.getElementById('stat-ballmaschine').textContent = counts.ballmaschine;
            document.getElementById('stat-match').textContent = counts.match;
            document.getElementById('stat-exercise').textContent = counts.exercise;
            document.getElementById('stat-freeplay').textContent = counts.freeplay;
            document.getElementById('stat-total').textContent = stats?.length || 0;
        }

        async function exportCSV() {
            showToast('Exportiere CSV...', 'info');

            // Get all labeled data
            const { data, error } = await supabase
                .from('video_labels')
                .select(`
                    id,
                    timestamp_start,
                    timestamp_end,
                    shot_type,
                    shot_from,
                    shot_to,
                    shot_result,
                    confidence,
                    created_at,
                    video:video_analyses(
                        id,
                        title,
                        video_url,
                        video_type,
                        exercise_id
                    )
                `)
                .order('created_at');

            if (error) {
                showToast('Export fehlgeschlagen: ' + error.message, 'error');
                return;
            }

            if (!data || data.length === 0) {
                showToast('Keine Daten zum Exportieren', 'warning');
                return;
            }

            // Build CSV
            const headers = [
                'label_id',
                'video_id',
                'video_title',
                'video_url',
                'video_type',
                'timestamp_start',
                'timestamp_end',
                'duration_ms',
                'shot_type',
                'shot_from',
                'shot_to',
                'shot_result',
                'confidence',
                'created_at'
            ];

            const rows = data.map(row => [
                row.id,
                row.video?.id || '',
                `"${(row.video?.title || '').replace(/"/g, '""')}"`,
                row.video?.video_url || '',
                row.video?.video_type || '',
                row.timestamp_start,
                row.timestamp_end,
                Math.round((row.timestamp_end - row.timestamp_start) * 1000),
                row.shot_type,
                row.shot_from || '',
                row.shot_to || '',
                row.shot_result || 'hit',
                row.confidence,
                row.created_at
            ]);

            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');

            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `tt-labels-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);

            showToast(`${data.length} Labels exportiert!`, 'success');
        }

        async function exportJSON() {
            showToast('Exportiere JSON...', 'info');

            // Get all labeled data with video info
            const { data, error } = await supabase
                .from('video_labels')
                .select(`
                    id,
                    timestamp_start,
                    timestamp_end,
                    shot_type,
                    shot_from,
                    shot_to,
                    shot_result,
                    confidence,
                    created_at,
                    video:video_analyses(
                        id,
                        title,
                        video_url,
                        video_type,
                        exercise_id,
                        exercise:exercises(name, category)
                    )
                `)
                .order('created_at');

            if (error) {
                showToast('Export fehlgeschlagen: ' + error.message, 'error');
                return;
            }

            if (!data || data.length === 0) {
                showToast('Keine Daten zum Exportieren', 'warning');
                return;
            }

            // Group by video for better structure
            const videoMap = {};
            data.forEach(label => {
                const videoId = label.video?.id;
                if (!videoId) return;

                if (!videoMap[videoId]) {
                    videoMap[videoId] = {
                        video_id: videoId,
                        title: label.video.title,
                        video_url: label.video.video_url,
                        video_type: label.video.video_type,
                        exercise: label.video.exercise?.name || null,
                        exercise_category: label.video.exercise?.category || null,
                        labels: []
                    };
                }

                videoMap[videoId].labels.push({
                    label_id: label.id,
                    timestamp_start: label.timestamp_start,
                    timestamp_end: label.timestamp_end,
                    duration_ms: Math.round((label.timestamp_end - label.timestamp_start) * 1000),
                    shot_type: label.shot_type,
                    shot_from: label.shot_from,
                    shot_to: label.shot_to,
                    shot_result: label.shot_result || 'hit',
                    confidence: label.confidence
                });
            });

            const exportData = {
                export_date: new Date().toISOString(),
                total_labels: data.length,
                total_videos: Object.keys(videoMap).length,
                videos: Object.values(videoMap)
            };

            // Download
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `tt-labels-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);

            showToast(`${data.length} Labels in ${Object.keys(videoMap).length} Videos exportiert!`, 'success');
        }

        async function loadExercises() {
            const { data: exercises } = await supabase
                .from('exercises')
                .select('id, name, category, difficulty')
                .order('category')
                .order('name');

            exercisesList = exercises || [];

            // Populate dropdown
            const select = document.getElementById('exercise-select');
            if (select && exercisesList.length > 0) {
                // Group by category
                const byCategory = {};
                exercisesList.forEach(ex => {
                    const cat = ex.category || 'Sonstiges';
                    if (!byCategory[cat]) byCategory[cat] = [];
                    byCategory[cat].push(ex);
                });

                select.innerHTML = '<option value="">-- √úbung ausw√§hlen --</option>';
                Object.entries(byCategory).forEach(([cat, exercises]) => {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = cat;
                    exercises.forEach(ex => {
                        const opt = document.createElement('option');
                        opt.value = ex.id;
                        opt.textContent = ex.name;
                        optgroup.appendChild(opt);
                    });
                    select.appendChild(optgroup);
                });
            }
        }

        async function loadPendingVideos() {
            const feedContainer = document.getElementById('video-feed');

            // Get ALL videos with allow_ai_training = true that aren't labeled yet
            // Includes: player uploads (with/without club), coach-assigned videos
            const { data: videos, error } = await supabase
                .from('video_analyses')
                .select(`
                    *,
                    uploader:profiles!uploaded_by(first_name, last_name),
                    comments:video_comments(count),
                    exercise:exercises(id, name, category)
                `)
                .eq('allow_ai_training', true)
                .eq('ai_ready', false)
                .order('created_at', { ascending: true });

            if (error) {
                console.error('Error loading videos:', error);
                feedContainer.innerHTML = '<p class="col-span-full text-center text-red-500 py-8">Fehler beim Laden: ' + error.message + '</p>';
                return;
            }

            const pendingVideos = videos || [];
            document.getElementById('pending-count').textContent = pendingVideos.length;

            if (pendingVideos.length === 0) {
                feedContainer.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-check-circle text-5xl text-green-400 mb-4"></i>
                        <p class="text-gray-600 font-medium">Alle Videos sind gelabelt!</p>
                        <p class="text-gray-500 text-sm mt-1">Es gibt keine Videos zum Labeln.</p>
                    </div>
                `;
                return;
            }

            feedContainer.innerHTML = pendingVideos.map(video => {
                const hasComments = video.comments?.[0]?.count > 0;
                return `
                <div class="video-card bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-shadow cursor-pointer"
                     data-video-id="${video.id}">
                    <div class="aspect-video bg-gray-200 relative">
                        ${video.thumbnail_url
                            ? `<img src="${video.thumbnail_url}" class="w-full h-full object-cover">`
                            : `<div class="w-full h-full flex items-center justify-center text-gray-400"><i class="fas fa-video text-4xl"></i></div>`
                        }
                        ${hasComments ? `<span class="absolute top-2 right-2 bg-blue-500 text-white text-xs px-2 py-1 rounded-full"><i class="fas fa-comment mr-1"></i>Kommentare</span>` : ''}
                    </div>
                    <div class="p-3">
                        <p class="font-medium text-sm truncate">${video.title || 'Ohne Titel'}</p>
                        <p class="text-xs text-gray-500 mt-1">
                            von ${video.uploader?.first_name || 'Unbekannt'} ${video.uploader?.last_name?.charAt(0) || ''}.
                        </p>
                        <p class="text-xs text-gray-400 mt-1">
                            ${new Date(video.created_at).toLocaleDateString('de-DE')}
                        </p>
                    </div>
                </div>
            `}).join('');

            // Add click handlers
            feedContainer.querySelectorAll('.video-card').forEach(card => {
                card.addEventListener('click', () => {
                    const videoId = card.dataset.videoId;
                    const video = pendingVideos.find(v => v.id === videoId);
                    if (video) openLabelingInterface(video);
                });
            });
        }

        async function openLabelingInterface(video) {
            currentVideo = video;
            currentShots = [];
            selectedVideoType = video.video_type || null;
            selectedExerciseId = video.exercise_id || null;

            document.getElementById('video-feed').classList.add('hidden');
            document.getElementById('labeling-interface').classList.remove('hidden');

            // Set video
            videoPlayer = document.getElementById('label-video');
            videoPlayer.src = video.video_url;
            document.getElementById('video-title').textContent = video.title || 'Ohne Titel';

            // Reset and set video type buttons
            document.querySelectorAll('.vtype-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
                btn.classList.add('bg-white', 'border-gray-300');
            });
            if (selectedVideoType) {
                const vtypeBtn = document.querySelector(`.vtype-btn[data-vtype="${selectedVideoType}"]`);
                if (vtypeBtn) {
                    vtypeBtn.classList.remove('bg-white', 'border-gray-300');
                    vtypeBtn.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                }
            }

            // Show/hide exercise selection
            const exerciseSelection = document.getElementById('exercise-selection');
            exerciseSelection.classList.toggle('hidden', selectedVideoType !== 'exercise');

            // Set exercise dropdown
            if (selectedExerciseId) {
                document.getElementById('exercise-select').value = selectedExerciseId;
            } else {
                document.getElementById('exercise-select').value = '';
            }

            // Show upload info if exercise was set
            const uploadInfo = document.getElementById('upload-info');
            const uploadExerciseName = document.getElementById('upload-exercise-name');
            if (video.exercise_id && video.exercise) {
                uploadInfo.classList.remove('hidden');
                uploadExerciseName.textContent = `üìã ${video.exercise.name}`;
            } else if (video.video_type) {
                uploadInfo.classList.remove('hidden');
                uploadExerciseName.textContent = `${videoTypeLabels[video.video_type] || video.video_type}`;
            } else {
                uploadInfo.classList.add('hidden');
            }

            // Load existing labels for this video
            const { data: existingLabels } = await supabase
                .from('video_labels')
                .select('*')
                .eq('video_id', video.id)
                .order('timestamp_start');

            if (existingLabels?.length > 0) {
                currentShots = existingLabels.map(label => ({
                    id: label.id,
                    startTime: label.timestamp_start,
                    endTime: label.timestamp_end,
                    shotType: label.shot_type,
                    shotFrom: label.shot_from,
                    shotTo: label.shot_to,
                    shotResult: label.shot_result || 'hit',
                    saved: true
                }));
            }

            // Load coach comments using RPC (SECURITY DEFINER bypasses RLS)
            console.log('Loading comments for video:', video.id);
            const { data: comments, error: commentsError } = await supabase.rpc('get_video_comments', {
                p_video_id: video.id
            });

            console.log('Comments loaded:', comments, 'Error:', commentsError);

            // Debug: Also try direct query
            const { data: directComments } = await supabase
                .from('video_comments')
                .select('*')
                .eq('video_id', video.id);
            console.log('Direct query comments:', directComments);

            if (commentsError) {
                console.error('Error loading comments:', commentsError);
            }

            const commentsContainer = document.getElementById('coach-comments');
            if (comments?.length > 0) {
                commentsContainer.innerHTML = comments.map(c => {
                    const userName = c.user_name || 'Unbekannt';
                    const isCoach = c.user_role === 'coach' || c.user_role === 'head_coach';

                    // Check if comment has a drawing (embedded in content as markdown)
                    const drawingMatch = c.content?.match(/\[Zeichnung\]\((https?:\/\/[^\)]+)\)/);
                    const hasDrawing = !!drawingMatch;
                    const drawingUrl = drawingMatch?.[1];

                    return `
                    <div class="bg-gray-50 rounded-lg p-2 text-sm">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-medium ${isCoach ? 'text-indigo-600' : 'text-gray-700'}">${userName}</span>
                            ${isCoach ? '<span class="text-xs bg-indigo-100 text-indigo-700 px-1.5 py-0.5 rounded">Coach</span>' : ''}
                            ${c.timestamp_seconds !== null
                                ? `<button class="comment-timestamp text-xs bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded" data-time="${c.timestamp_seconds}">${formatTime(c.timestamp_seconds)}</button>`
                                : ''
                            }
                        </div>
                        ${hasDrawing && drawingUrl
                            ? `<img src="${drawingUrl}" class="max-w-full rounded border border-gray-200 mb-2 cursor-pointer hover:opacity-90" style="max-height: 150px;" onclick="window.open('${drawingUrl}', '_blank')">`
                            : `<p class="text-gray-700">${c.content}</p>`
                        }
                    </div>
                `}).join('');

                // Add click handlers for timestamps
                commentsContainer.querySelectorAll('.comment-timestamp').forEach(btn => {
                    btn.addEventListener('click', () => {
                        videoPlayer.currentTime = parseFloat(btn.dataset.time);
                    });
                });
            } else {
                commentsContainer.innerHTML = '<p class="text-gray-500 text-sm text-center">Keine Kommentare</p>';
            }

            // Video time update
            videoPlayer.addEventListener('loadedmetadata', () => {
                document.getElementById('total-time').textContent = formatTime(videoPlayer.duration);
                document.getElementById('timeline-end').textContent = formatTime(videoPlayer.duration);
            });

            videoPlayer.addEventListener('timeupdate', () => {
                document.getElementById('current-time').textContent = formatTime(videoPlayer.currentTime);
                updateTimelineMarker();
            });

            renderShotsList();
            renderTimeline();
        }

        function setupEventListeners() {
            // Back button
            document.getElementById('back-to-feed').addEventListener('click', () => {
                document.getElementById('labeling-interface').classList.add('hidden');
                document.getElementById('video-feed').classList.remove('hidden');
                currentVideo = null;
                currentShots = [];
                selectedVideoType = null;
                selectedExerciseId = null;
            });

            // Export buttons
            document.getElementById('export-csv-btn').addEventListener('click', exportCSV);
            document.getElementById('export-json-btn').addEventListener('click', exportJSON);

            // Video type buttons
            document.querySelectorAll('.vtype-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.vtype-btn').forEach(b => {
                        b.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
                        b.classList.add('bg-white', 'border-gray-300');
                    });
                    btn.classList.remove('bg-white', 'border-gray-300');
                    btn.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                    selectedVideoType = btn.dataset.vtype;

                    // Show/hide exercise selection
                    const exerciseSelection = document.getElementById('exercise-selection');
                    exerciseSelection.classList.toggle('hidden', selectedVideoType !== 'exercise');

                    // Reset exercise if not exercise type
                    if (selectedVideoType !== 'exercise') {
                        selectedExerciseId = null;
                        document.getElementById('exercise-select').value = '';
                    }
                });
            });

            // Exercise dropdown
            document.getElementById('exercise-select').addEventListener('change', (e) => {
                selectedExerciseId = e.target.value || null;
            });

            // "Von" position buttons
            document.querySelectorAll('.from-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.from-btn').forEach(b => {
                        b.classList.remove('bg-indigo-600', 'bg-purple-600', 'text-white');
                        b.classList.add('bg-white');
                    });
                    btn.classList.remove('bg-white');
                    const color = btn.dataset.from === 'rh' ? 'bg-purple-600' : 'bg-indigo-600';
                    btn.classList.add(color, 'text-white');
                });
            });

            // "Nach" position buttons
            document.querySelectorAll('.to-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.to-btn').forEach(b => {
                        b.classList.remove('bg-indigo-600', 'bg-purple-600', 'text-white');
                        b.classList.add('bg-white');
                    });
                    btn.classList.remove('bg-white');
                    const color = btn.dataset.to === 'rh' ? 'bg-purple-600' : 'bg-indigo-600';
                    btn.classList.add(color, 'text-white');
                });
            });

            // Shot type buttons
            document.querySelectorAll('.shot-type-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.shot-type-btn').forEach(b => {
                        b.classList.remove('bg-indigo-600', 'bg-purple-600', 'text-white', 'border-indigo-600', 'border-purple-600');
                        b.classList.add('border-gray-300');
                    });
                    const isBackhand = btn.dataset.type.startsWith('backhand');
                    btn.classList.remove('border-gray-300');
                    btn.classList.add(isBackhand ? 'bg-purple-600' : 'bg-indigo-600', 'text-white');
                });
            });

            // Result buttons
            document.querySelectorAll('.result-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.result-btn').forEach(b => {
                        b.classList.remove('bg-green-600', 'bg-orange-500', 'bg-red-500', 'bg-gray-500', 'text-white');
                        b.classList.add('bg-white');
                    });
                    btn.classList.remove('bg-white');
                    const colors = {
                        'hit': 'bg-green-600',
                        'net': 'bg-orange-500',
                        'out': 'bg-red-500',
                        'miss': 'bg-gray-500'
                    };
                    btn.classList.add(colors[btn.dataset.result], 'text-white');
                });
            });

            // Set current time buttons (with milliseconds)
            document.getElementById('set-start-current').addEventListener('click', () => {
                if (videoPlayer) {
                    const time = videoPlayer.currentTime;
                    document.getElementById('shot-start-min').value = Math.floor(time / 60);
                    document.getElementById('shot-start-sec').value = Math.floor(time % 60);
                    document.getElementById('shot-start-ms').value = Math.floor((time % 1) * 1000);
                }
            });

            document.getElementById('set-end-current').addEventListener('click', () => {
                if (videoPlayer) {
                    const time = videoPlayer.currentTime;
                    document.getElementById('shot-end-min').value = Math.floor(time / 60);
                    document.getElementById('shot-end-sec').value = Math.floor(time % 60);
                    document.getElementById('shot-end-ms').value = Math.floor((time % 1) * 1000);
                }
            });

            // Add shot button
            document.getElementById('add-shot-btn').addEventListener('click', addShot);

            // Verify button
            document.getElementById('verify-btn').addEventListener('click', verifyAndSave);

            // Skip button
            document.getElementById('skip-btn').addEventListener('click', skipVideo);

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (!currentVideo) return;
                if (e.target.tagName === 'INPUT') return;

                switch(e.key) {
                    case ' ':
                        e.preventDefault();
                        videoPlayer.paused ? videoPlayer.play() : videoPlayer.pause();
                        break;
                    case 's':
                    case 'S':
                        document.getElementById('set-start-current').click();
                        break;
                    case 'e':
                    case 'E':
                        document.getElementById('set-end-current').click();
                        break;
                    case 'Enter':
                        addShot();
                        break;
                    case '1':
                    case '2':
                    case '3':
                    case '4':
                    case '5':
                    case '6':
                    case '7':
                    case '8':
                        const shotTypes = document.querySelectorAll('.shot-type-btn');
                        const index = parseInt(e.key) - 1;
                        if (shotTypes[index]) shotTypes[index].click();
                        break;
                }
            });
        }

        function addShot() {
            // Get values
            const startMin = parseInt(document.getElementById('shot-start-min').value) || 0;
            const startSec = parseInt(document.getElementById('shot-start-sec').value) || 0;
            const startMs = parseInt(document.getElementById('shot-start-ms').value) || 0;
            const endMin = parseInt(document.getElementById('shot-end-min').value) || 0;
            const endSec = parseInt(document.getElementById('shot-end-sec').value) || 0;
            const endMs = parseInt(document.getElementById('shot-end-ms').value) || 0;

            // Zeit in Sekunden mit Millisekunden-Pr√§zision
            const startTime = startMin * 60 + startSec + (startMs / 1000);
            const endTime = endMin * 60 + endSec + (endMs / 1000);

            // Get "Von" position
            const fromBtn = document.querySelector('.from-btn.bg-indigo-600, .from-btn.bg-purple-600');
            const shotFrom = fromBtn?.dataset.from || null;

            // Get "Nach" position
            const toBtn = document.querySelector('.to-btn.bg-indigo-600, .to-btn.bg-purple-600');
            const shotTo = toBtn?.dataset.to || null;

            const shotTypeBtn = document.querySelector('.shot-type-btn.bg-indigo-600, .shot-type-btn.bg-purple-600');
            const shotType = shotTypeBtn?.dataset.type || null;

            // Get result
            const resultBtn = document.querySelector('.result-btn.bg-green-600, .result-btn.bg-orange-500, .result-btn.bg-red-500, .result-btn.bg-gray-500');
            const shotResult = resultBtn?.dataset.result || 'hit'; // Default: hit

            // Validation
            if (!shotType) {
                showToast('Bitte Schlagtyp ausw√§hlen', 'warning');
                return;
            }

            if (endTime <= startTime) {
                showToast('Endzeit muss nach Startzeit liegen', 'warning');
                return;
            }

            // Add shot
            currentShots.push({
                id: Date.now().toString(),
                startTime,
                endTime,
                shotType,
                shotFrom,
                shotTo,
                shotResult,
                saved: false
            });

            // Reset form
            document.querySelectorAll('.from-btn, .to-btn, .shot-type-btn').forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'bg-purple-600', 'text-white', 'border-indigo-600', 'border-purple-600');
                btn.classList.add('bg-white', 'border-gray-300');
            });

            // Reset result to default (hit)
            document.querySelectorAll('.result-btn').forEach(btn => {
                btn.classList.remove('bg-green-600', 'bg-orange-500', 'bg-red-500', 'bg-gray-500', 'text-white');
                btn.classList.add('bg-white');
            });
            document.querySelector('.result-btn[data-result="hit"]').classList.remove('bg-white');
            document.querySelector('.result-btn[data-result="hit"]').classList.add('bg-green-600', 'text-white');

            renderShotsList();
            renderTimeline();
            showToast('Schlag hinzugef√ºgt', 'success');
        }

        function renderShotsList() {
            const container = document.getElementById('shots-list');
            document.getElementById('shot-count').textContent = currentShots.length;

            if (currentShots.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">Noch keine Schl√§ge markiert</p>';
                return;
            }

            const posLabels = { vh: 'VH', mitte: 'M', rh: 'RH' };
            const resultLabels = { hit: '‚úì', net: 'ü•Ö', out: '‚Üó', miss: '‚úó' };
            const resultColors = { hit: 'text-green-600', net: 'text-orange-500', out: 'text-red-500', miss: 'text-gray-500' };
            container.innerHTML = currentShots.map((shot, index) => `
                <div class="shot-item flex items-center justify-between p-2 bg-gray-50 rounded-lg group">
                    <div class="flex items-center gap-2 flex-wrap">
                        <span class="text-xs font-mono text-gray-500">${formatTime(shot.startTime)}-${formatTime(shot.endTime)}</span>
                        <span class="text-sm font-medium ${shot.shotType.startsWith('backhand') ? 'text-purple-600' : 'text-indigo-600'}">
                            ${shotTypeLabels[shot.shotType] || shot.shotType}
                        </span>
                        ${shot.shotFrom || shot.shotTo ? `<span class="text-xs text-gray-400">(${posLabels[shot.shotFrom] || '?'} ‚Üí ${posLabels[shot.shotTo] || '?'})</span>` : ''}
                        <span class="${resultColors[shot.shotResult] || 'text-green-600'}" title="${shot.shotResult}">${resultLabels[shot.shotResult] || '‚úì'}</span>
                    </div>
                    <button class="delete-shot opacity-0 group-hover:opacity-100 text-red-500 hover:text-red-700 p-1 transition-opacity" data-index="${index}">
                        <i class="fas fa-trash text-xs"></i>
                    </button>
                </div>
            `).join('');

            // Delete handlers
            container.querySelectorAll('.delete-shot').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = parseInt(btn.dataset.index);
                    currentShots.splice(index, 1);
                    renderShotsList();
                    renderTimeline();
                });
            });
        }

        function renderTimeline() {
            const timeline = document.getElementById('timeline');
            const duration = videoPlayer?.duration || 1;

            // Clear existing markers
            timeline.querySelectorAll('.shot-marker').forEach(m => m.remove());

            // Add shot markers
            currentShots.forEach(shot => {
                const startPercent = (shot.startTime / duration) * 100;
                const widthPercent = ((shot.endTime - shot.startTime) / duration) * 100;
                const isBackhand = shot.shotType.startsWith('backhand');

                const marker = document.createElement('div');
                marker.className = `shot-marker absolute top-0 h-full ${isBackhand ? 'bg-purple-500' : 'bg-indigo-500'} opacity-50 hover:opacity-75 cursor-pointer`;
                marker.style.left = `${startPercent}%`;
                marker.style.width = `${widthPercent}%`;
                marker.title = `${shotTypeLabels[shot.shotType]}: ${formatTime(shot.startTime)} - ${formatTime(shot.endTime)}`;

                marker.addEventListener('click', () => {
                    videoPlayer.currentTime = shot.startTime;
                });

                timeline.appendChild(marker);
            });
        }

        function updateTimelineMarker() {
            // Could add a current position marker here
        }

        async function verifyAndSave() {
            if (currentShots.length === 0) {
                showToast('Bitte mindestens einen Schlag markieren', 'warning');
                return;
            }

            try {
                // Save new shots to video_labels
                const newShots = currentShots.filter(s => !s.saved);
                if (newShots.length > 0) {
                    const labelsToInsert = newShots.map(shot => ({
                        video_id: currentVideo.id,
                        labeled_by: currentUser.id,
                        club_id: currentVideo.club_id,
                        timestamp_start: shot.startTime,
                        timestamp_end: shot.endTime,
                        event_type: 'shot',
                        shot_type: shot.shotType,
                        shot_from: shot.shotFrom,
                        shot_to: shot.shotTo,
                        shot_result: shot.shotResult,
                        confidence: 'certain',
                        is_verified: true,
                        verified_by: currentUser.id
                    }));

                    const { error: insertError } = await supabase
                        .from('video_labels')
                        .insert(labelsToInsert);

                    if (insertError) throw insertError;
                }

                // Mark video as ai_ready and save video type/exercise
                const updateData = { ai_ready: true };
                if (selectedVideoType) updateData.video_type = selectedVideoType;
                if (selectedExerciseId) updateData.exercise_id = selectedExerciseId;

                const { error: updateError } = await supabase
                    .from('video_analyses')
                    .update(updateData)
                    .eq('id', currentVideo.id);

                if (updateError) throw updateError;

                showToast('Video verifiziert und gespeichert!', 'success');

                // Update stats
                loadStats();

                // Go back to feed
                document.getElementById('back-to-feed').click();
                loadPendingVideos();

            } catch (error) {
                console.error('Error saving:', error);
                showToast('Fehler beim Speichern', 'error');
            }
        }

        async function skipVideo() {
            try {
                // Mark as ai_ready but add metadata that it's unsuitable
                const { error } = await supabase
                    .from('video_analyses')
                    .update({ ai_ready: true })
                    .eq('id', currentVideo.id);

                // Also add to ml_metadata as unsuitable
                await supabase.from('video_ml_metadata').upsert({
                    video_id: currentVideo.id,
                    suitable_for_training: false,
                    exclusion_reason: 'Manually marked as unsuitable'
                });

                if (error) throw error;

                showToast('Video √ºbersprungen', 'info');
                document.getElementById('back-to-feed').click();
                loadPendingVideos();

            } catch (error) {
                console.error('Error skipping:', error);
                showToast('Fehler beim √úberspringen', 'error');
            }
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            const ms = Math.floor((seconds % 1) * 1000);
            return `${mins}:${secs.toString().padStart(2, '0')}.${ms.toString().padStart(3, '0')}`;
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-indigo-500'
            };

            const toast = document.createElement('div');
            toast.className = `${colors[type]} text-white px-4 py-2 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full`;
            toast.textContent = message;

            container.appendChild(toast);
            setTimeout(() => toast.classList.remove('translate-x-full'), 10);
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
