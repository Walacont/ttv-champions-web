<!doctype html>
<html lang="de">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

        <!-- Cookie Consent & Analytics -->
        <script src="/js/cookie-consent.js"></script>

        <script src="/js/capacitor-init.js"></script>
        <title>Einstellungen - SC Champions</title>

        <!-- Favicon -->
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

        <!-- PWA Meta Tags -->
        <link rel="manifest" href="/manifest.json" />
        <meta name="theme-color" content="#1e3a5f" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
        <meta name="apple-mobile-web-app-title" content="SC Champions" />
        <link rel="apple-touch-icon" href="/icons/icon-152x152.png" />
        <meta name="mobile-web-app-capable" content="yes" />

        <script src="https://cdn.tailwindcss.com"></script>
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />
        <link rel="stylesheet" href="/css/spa-enhancements.css" />
        <link rel="stylesheet" href="/css/mobile-fixes.css" />
        <style>
            body {
                font-family: 'Inter', sans-serif;
            }
            #page-loader {
                display: flex;
                justify-content: center;
                align-items: center;
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background-color: #f3f4f6;
                z-index: 9999;
            }
            #main-content {
                display: none;
            }
            .settings-card {
                transition: all 0.2s;
            }
            .settings-card:active {
                transform: scale(0.98);
                background-color: #f9fafb;
            }
        </style>
    </head>
    <body class="bg-gray-100 text-gray-800">
        <div id="page-loader">
            <svg
                class="animate-spin h-10 w-10 text-indigo-600"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
            >
                <circle
                    class="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    stroke-width="4"
                ></circle>
                <path
                    class="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
            </svg>
        </div>

        <div id="main-content" class="container mx-auto p-4 sm:p-6 md:p-8 max-w-2xl">
            <div class="mb-8">
                <a
                    href="/dashboard.html"
                    class="text-indigo-600 hover:text-indigo-800 font-semibold inline-flex items-center mb-4"
                >
                    <i class="fas fa-arrow-left mr-2"></i>
                    <span data-i18n="common.back">ZurÃ¼ck</span>
                </a>
                <h1 class="text-3xl font-bold text-gray-900 text-center" data-i18n="settings.title">Einstellungen</h1>
            </div>

            <!-- Settings Navigation Cards -->
            <div class="space-y-3">
                <!-- Profil bearbeiten -->
                <a
                    href="/settings-profile.html"
                    class="settings-card block bg-white p-4 rounded-xl shadow-sm hover:shadow-md cursor-pointer border border-gray-200"
                >
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-indigo-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900" data-i18n="settings.profile.title">Profil bearbeiten</h3>
                                <p class="text-sm text-gray-500" data-i18n="settings.profile.subtitle">Name, Email, Passwort, Foto</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </a>

                <!-- Benachrichtigungen (nur in PWA/native App sichtbar) -->
                <a
                    id="notifications-card"
                    href="/settings-notifications.html"
                    class="settings-card block bg-white p-4 rounded-xl shadow-sm hover:shadow-md cursor-pointer border border-gray-200 hidden"
                >
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-bell text-red-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900" data-i18n="settings.notifications.title">Benachrichtigungen</h3>
                                <p class="text-sm text-gray-500" data-i18n="settings.notifications.subtitle">Push-Benachrichtigungen verwalten</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </a>

                <!-- PrivatsphÃ¤re -->
                <a
                    href="/settings-privacy.html"
                    class="settings-card block bg-white p-4 rounded-xl shadow-sm hover:shadow-md cursor-pointer border border-gray-200"
                >
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-shield-alt text-purple-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900" data-i18n="settings.privacy.title">PrivatsphÃ¤re</h3>
                                <p class="text-sm text-gray-500" data-i18n="settings.privacy.subtitle">Sichtbarkeit und Datenschutz</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </a>

                <!-- Vereinsverwaltung -->
                <a
                    href="/settings-club.html"
                    class="settings-card block bg-white p-4 rounded-xl shadow-sm hover:shadow-md cursor-pointer border border-gray-200"
                >
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-users text-blue-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900" data-i18n="settings.club.title">Vereinsverwaltung</h3>
                                <p class="text-sm text-gray-500" data-i18n="settings.club.subtitle">Verein beitreten oder verlassen</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </a>

                <!-- Meine Kinder (nur fÃ¼r VormÃ¼nder sichtbar) -->
                <a
                    id="my-children-card"
                    href="/settings-children.html"
                    class="settings-card block bg-white p-4 rounded-xl shadow-sm hover:shadow-md cursor-pointer border border-gray-200 hidden"
                >
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-pink-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-child text-pink-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900">Meine Kinder</h3>
                                <p id="my-children-subtitle" class="text-sm text-gray-500">Kinder verwalten</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </a>

                <!-- Support -->
                <a
                    href="/settings-support.html"
                    class="settings-card block bg-white p-4 rounded-xl shadow-sm hover:shadow-md cursor-pointer border border-gray-200"
                >
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-question-circle text-green-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900" data-i18n="settings.support.title">Support</h3>
                                <p class="text-sm text-gray-500" data-i18n="settings.support.subtitle">Hilfe, Tutorials und FAQs</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </a>

                <!-- Language Selection -->
                <div
                    id="language-card"
                    class="settings-card block bg-white p-4 rounded-xl shadow-sm hover:shadow-md cursor-pointer border border-gray-200"
                >
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-language text-amber-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900" data-i18n="settings.language.title">Sprache</h3>
                                <p class="text-sm text-gray-500" data-i18n="settings.language.subtitle">App-Sprache Ã¤ndern</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </div>

                <!-- Rechtsinformationen -->
                <a
                    href="/settings-legal.html"
                    class="settings-card block bg-white p-4 rounded-xl shadow-sm hover:shadow-md cursor-pointer border border-gray-200"
                >
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-gavel text-gray-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900" data-i18n="settings.legal.title">Rechtsinformationen</h3>
                                <p class="text-sm text-gray-500" data-i18n="settings.legal.subtitle">Datenexport, Account lÃ¶schen</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </a>

                <!-- Cache Reset (for PWA issues) -->
                <div
                    id="cache-reset-card"
                    class="settings-card block bg-white p-4 rounded-xl shadow-sm hover:shadow-md cursor-pointer border border-gray-200"
                >
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-sync-alt text-orange-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900">Cache zurÃ¼cksetzen</h3>
                                <p class="text-sm text-gray-500">Bei Anzeigeproblemen oder veralteten Daten</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </div>

                <!-- Logout Button -->
                <div class="pt-4">
                    <button
                        id="logout-button"
                        class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-xl shadow-md transition-transform transform hover:scale-[1.02] flex items-center justify-center gap-2"
                    >
                        <i class="fas fa-sign-out-alt"></i>
                        <span data-i18n="settings.logout">Abmelden</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Language Selection Modal -->
        <div id="language-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 transform transition-all">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-900" data-i18n="settings.language.select">Sprache auswÃ¤hlen</h2>
                    <button id="close-language-modal" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="space-y-3">
                    <button
                        class="language-option w-full flex items-center justify-between p-4 rounded-xl border-2 hover:bg-gray-50 transition-all"
                        data-lang="de"
                    >
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">ðŸ‡©ðŸ‡ª</span>
                            <span class="font-semibold text-gray-900" data-i18n="settings.language.german">Deutsch</span>
                        </div>
                        <i class="fas fa-check text-indigo-600 hidden check-icon"></i>
                    </button>
                    <button
                        class="language-option w-full flex items-center justify-between p-4 rounded-xl border-2 hover:bg-gray-50 transition-all"
                        data-lang="en"
                    >
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">ðŸ‡¬ðŸ‡§</span>
                            <span class="font-semibold text-gray-900" data-i18n="settings.language.english">English</span>
                        </div>
                        <i class="fas fa-check text-indigo-600 hidden check-icon"></i>
                    </button>
                    <button
                        class="language-option w-full flex items-center justify-between p-4 rounded-xl border-2 hover:bg-gray-50 transition-all"
                        data-lang="zh"
                    >
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">ðŸ‡¨ðŸ‡³</span>
                            <span class="font-semibold text-gray-900" data-i18n="settings.language.chinese">ç®€ä½“ä¸­æ–‡</span>
                        </div>
                        <i class="fas fa-check text-indigo-600 hidden check-icon"></i>
                    </button>
                </div>
            </div>
        </div>

        <script src="/js/update-checker.js"></script>
        <script src="/js/pwa-register.js"></script>
        <script type="module" src="/js/notifications.js"></script>
        <script type="module" src="/js/spa-enhancer.js"></script>
        <script type="module">
            import { getSupabase } from '/js/supabase-init.js';
            import { initI18n, changeLanguage, getCurrentLanguage, translatePage, setupAutoTranslate } from '/js/i18n.js';

            // PrÃ¼ft ob Push-Benachrichtigungen unterstÃ¼tzt werden (PWA oder native App)
            function isPushSupported() {
                if (window.CapacitorUtils?.isNative()) return true;
                if (window.matchMedia('(display-mode: standalone)').matches) return true;
                if (window.navigator.standalone === true) return true;
                return false;
            }

            // Check if user is a guardian and show children card
            async function checkGuardianStatus() {
                const supabase = getSupabase();
                const { data: { user } } = await supabase.auth.getUser();

                if (!user) return;

                try {
                    // Get profile and check is_guardian flag
                    const { data: profile, error } = await supabase
                        .from('profiles')
                        .select('is_guardian')
                        .eq('id', user.id)
                        .single();

                    if (error) {
                        console.error('Error checking guardian status:', error);
                        return;
                    }

                    const myChildrenCard = document.getElementById('my-children-card');
                    const myChildrenSubtitle = document.getElementById('my-children-subtitle');

                    if (profile?.is_guardian) {
                        // Show the card for guardians
                        myChildrenCard?.classList.remove('hidden');

                        // Get children count
                        const { data: children, error: childrenError } = await supabase.rpc('get_my_children');

                        if (!childrenError && children?.success && children.children) {
                            const childCount = children.children.length;
                            if (childCount === 0) {
                                myChildrenSubtitle.textContent = 'Keine Kinder verknÃ¼pft';
                            } else if (childCount === 1) {
                                myChildrenSubtitle.textContent = '1 Kind verknÃ¼pft';
                            } else {
                                myChildrenSubtitle.textContent = `${childCount} Kinder verknÃ¼pft`;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error in checkGuardianStatus:', error);
                }
            }

            // Initialize immediately or on DOMContentLoaded
            async function init() {
                // Initialize i18n first
                await initI18n();
                setupAutoTranslate();
                translatePage();

                // Update HTML lang attribute
                document.documentElement.lang = getCurrentLanguage();

                // Benachrichtigungen-Card nur in PWA/native anzeigen
                const notificationsCard = document.getElementById('notifications-card');
                if (notificationsCard && isPushSupported()) {
                    notificationsCard.classList.remove('hidden');
                }

                // Check if user is a guardian and show "Meine Kinder" card
                await checkGuardianStatus();

                document.getElementById('page-loader').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';

                // Language selection modal
                const languageCard = document.getElementById('language-card');
                const languageModal = document.getElementById('language-modal');
                const closeModalBtn = document.getElementById('close-language-modal');
                const languageOptions = document.querySelectorAll('.language-option');

                // Update active language indicator
                function updateActiveLanguage() {
                    const currentLang = getCurrentLanguage();
                    languageOptions.forEach(option => {
                        const lang = option.getAttribute('data-lang');
                        const checkIcon = option.querySelector('.check-icon');
                        if (lang === currentLang) {
                            option.classList.add('border-indigo-600', 'bg-indigo-50');
                            checkIcon.classList.remove('hidden');
                        } else {
                            option.classList.remove('border-indigo-600', 'bg-indigo-50');
                            checkIcon.classList.add('hidden');
                        }
                    });
                }

                // Show modal
                languageCard.addEventListener('click', () => {
                    languageModal.classList.remove('hidden');
                    updateActiveLanguage();
                });

                // Close modal
                closeModalBtn.addEventListener('click', () => {
                    languageModal.classList.add('hidden');
                });

                // Close modal on backdrop click
                languageModal.addEventListener('click', (e) => {
                    if (e.target === languageModal) {
                        languageModal.classList.add('hidden');
                    }
                });

                // Language selection
                languageOptions.forEach(option => {
                    option.addEventListener('click', async () => {
                        const selectedLang = option.getAttribute('data-lang');
                        await changeLanguage(selectedLang);
                        updateActiveLanguage();

                        // Show success feedback
                        const feedback = document.createElement('div');
                        feedback.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                        feedback.innerHTML = '<i class="fas fa-check mr-2"></i><span data-i18n="settings.language.changed">Sprache wurde geÃ¤ndert</span>';
                        document.body.appendChild(feedback);
                        translatePage(); // Re-translate the feedback message

                        setTimeout(() => {
                            feedback.remove();
                            languageModal.classList.add('hidden');
                        }, 2000);
                    });
                });

                // Cache reset functionality
                document.getElementById('cache-reset-card').addEventListener('click', async () => {
                    if (confirm('Cache und lokale Daten zurÃ¼cksetzen? Die App wird danach neu geladen.')) {
                        try {
                            // Clear localStorage (but preserve auth)
                            const authData = localStorage.getItem('sb-auth-token');
                            localStorage.clear();
                            if (authData) {
                                localStorage.setItem('sb-auth-token', authData);
                            }

                            // Clear all caches
                            if ('caches' in window) {
                                const cacheNames = await caches.keys();
                                await Promise.all(cacheNames.map(name => caches.delete(name)));
                            }

                            // Unregister service workers
                            if ('serviceWorker' in navigator) {
                                const registrations = await navigator.serviceWorker.getRegistrations();
                                await Promise.all(registrations.map(reg => reg.unregister()));
                            }

                            // Force reload
                            window.location.reload(true);
                        } catch (error) {
                            console.error('Cache reset error:', error);
                            alert('Fehler beim ZurÃ¼cksetzen: ' + error.message);
                        }
                    }
                });

                // Logout functionality
                document.getElementById('logout-button').addEventListener('click', async () => {
                    const supabase = getSupabase();
                    const { error } = await supabase.auth.signOut();

                    if (error) {
                        console.error('Logout error:', error);
                        alert('Fehler beim Abmelden: ' + error.message);
                    } else {
                        window.location.href = '/index.html';
                    }
                });
            }

            // Initialize on DOMContentLoaded or immediately if already loaded (for SPA navigation)
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        </script>
    </body>
</html>
