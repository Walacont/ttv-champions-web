<!doctype html>
<html lang="de">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

        <!-- Cookie Consent & Analytics -->
        <script src="/js/cookie-consent.js"></script>

        <script src="/js/capacitor-init.js"></script>
        <script src="/js/avatar-utils.js"></script>

        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-H2R9ZJYQ06"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag() {
                dataLayer.push(arguments);
            }
            gtag('js', new Date());
            gtag('config', 'G-H2R9ZJYQ06');
        </script>

        <title>Einstellungen - SC Champions</title>

        <!-- Favicon -->
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

        <!-- PWA Meta Tags -->
        <link rel="manifest" href="/manifest.json" />
        <meta name="theme-color" content="#1e3a5f" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
        <meta name="apple-mobile-web-app-title" content="SC Champions" />
        <link rel="apple-touch-icon" href="/icons/icon-152x152.png" />
        <meta name="mobile-web-app-capable" content="yes" />

        <link rel="stylesheet" href="/css/tailwind.css" />
        <link rel="stylesheet" href="/vendor/fonts/inter.css" />
        <link
            rel="stylesheet"
            href="/vendor/fontawesome/css/all.min.css"
        />
        <link rel="stylesheet" href="/css/spa-enhancements.css" />
        <link rel="stylesheet" href="/css/mobile-fixes.css" />
        <style>
            /* Fallback for when Tailwind CDN doesn't load */
            .hidden { display: none !important; }
            body {
                font-family: 'Inter', sans-serif;
            }
            #page-loader {
                display: flex;
                justify-content: center;
                align-items: center;
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background-color: #f3f4f6;
                z-index: 9999;
            }
            #main-content {
                display: none;
            }
            .settings-card {
                transition: all 0.2s;
            }
            .settings-card:active {
                transform: scale(0.98);
                background-color: #f9fafb;
            }
        </style>
    </head>
    <body class="bg-gray-100 text-gray-800">
        <div id="page-loader">
            <svg
                class="animate-spin h-10 w-10 text-indigo-600"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
            >
                <circle
                    class="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    stroke-width="4"
                ></circle>
                <path
                    class="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
            </svg>
        </div>

        <div id="main-content" class="container mx-auto p-4 sm:p-6 md:p-8 max-w-2xl">
            <div class="mb-8">
                <a
                    href="/dashboard.html"
                    class="text-indigo-600 hover:text-indigo-800 font-semibold inline-flex items-center mb-4"
                >
                    <i class="fas fa-arrow-left mr-2"></i>
                    <span data-i18n="common.back">ZurÃ¼ck</span>
                </a>
                <h1 class="text-3xl font-bold text-gray-900 text-center" data-i18n="settings.title">Einstellungen</h1>
            </div>

            <!-- Settings Navigation Cards -->
            <div class="space-y-3">
                <!-- Profil bearbeiten -->
                <a
                    href="/settings-profile.html"
                    class="settings-card block bg-white p-4 rounded-xl shadow-sm hover:shadow-md cursor-pointer border border-gray-200"
                >
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-indigo-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900" data-i18n="settings.profile.title">Profil bearbeiten</h3>
                                <p class="text-sm text-gray-500" data-i18n="settings.profile.subtitle">Name, Email, Passwort, Foto</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </a>

                <!-- Benachrichtigungen (nur in PWA/native App sichtbar) -->
                <a
                    id="notifications-card"
                    href="/settings-notifications.html"
                    class="settings-card block bg-white p-4 rounded-xl shadow-sm hover:shadow-md cursor-pointer border border-gray-200 hidden"
                >
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-bell text-red-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900" data-i18n="settings.notifications.title">Benachrichtigungen</h3>
                                <p class="text-sm text-gray-500" data-i18n="settings.notifications.subtitle">Push-Benachrichtigungen verwalten</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </a>

                <!-- PrivatsphÃ¤re -->
                <a
                    href="/settings-privacy.html"
                    class="settings-card block bg-white p-4 rounded-xl shadow-sm hover:shadow-md cursor-pointer border border-gray-200"
                >
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-shield-alt text-purple-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900" data-i18n="settings.privacy.title">PrivatsphÃ¤re</h3>
                                <p class="text-sm text-gray-500" data-i18n="settings.privacy.subtitle">Sichtbarkeit und Datenschutz</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </a>

                <!-- Vereinsverwaltung -->
                <a
                    href="/settings-club.html"
                    class="settings-card block bg-white p-4 rounded-xl shadow-sm hover:shadow-md cursor-pointer border border-gray-200"
                >
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-users text-blue-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900" data-i18n="settings.club.title">Vereinsverwaltung</h3>
                                <p class="text-sm text-gray-500" data-i18n="settings.club.subtitle">Verein beitreten oder verlassen</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </a>

                <!-- Vereinsseite (nur fÃ¼r Coaches/Head-Coaches) -->
                <a
                    id="club-page-card"
                    href="/club-page.html"
                    class="settings-card block bg-white p-4 rounded-xl shadow-sm hover:shadow-md cursor-pointer border border-gray-200 hidden"
                >
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-building text-emerald-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900">Vereinsseite</h3>
                                <p class="text-sm text-gray-500">Logo, Beschreibung & Trainingszeiten</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </a>

                <!-- Meine Kinder (fÃ¼r alle Benutzer, die Guardian sind oder werden wollen) -->
                <a
                    id="my-children-card"
                    href="/guardian-dashboard.html?from=settings"
                    class="settings-card block bg-white p-4 rounded-xl shadow-sm hover:shadow-md cursor-pointer border border-gray-200 hidden"
                >
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-pink-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-child text-pink-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900">Meine Kinder</h3>
                                <p id="my-children-subtitle" class="text-sm text-gray-500">Kinder verwalten</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </a>

                <!-- Kind hinzufÃ¼gen (fÃ¼r alle Benutzer, die noch kein Guardian sind) -->
                <a
                    id="add-child-card"
                    href="/guardian-dashboard.html?from=settings"
                    class="settings-card block bg-white p-4 rounded-xl shadow-sm hover:shadow-md cursor-pointer border border-gray-200 hidden"
                >
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-pink-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-plus-circle text-pink-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900">Kind hinzufÃ¼gen</h3>
                                <p class="text-sm text-gray-500">Mit oder ohne Einladungscode</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </a>

                <!-- Support -->
                <a
                    href="/settings-support.html"
                    class="settings-card block bg-white p-4 rounded-xl shadow-sm hover:shadow-md cursor-pointer border border-gray-200"
                >
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-question-circle text-green-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900" data-i18n="settings.support.title">Support</h3>
                                <p class="text-sm text-gray-500" data-i18n="settings.support.subtitle">Hilfe, Tutorials und FAQs</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </a>

                <!-- Language Selection -->
                <div
                    id="language-card"
                    class="settings-card block bg-white p-4 rounded-xl shadow-sm hover:shadow-md cursor-pointer border border-gray-200"
                >
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-language text-amber-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900" data-i18n="settings.language.title">Sprache</h3>
                                <p class="text-sm text-gray-500" data-i18n="settings.language.subtitle">App-Sprache Ã¤ndern</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </div>

                <!-- Rechtsinformationen -->
                <a
                    href="/settings-legal.html"
                    class="settings-card block bg-white p-4 rounded-xl shadow-sm hover:shadow-md cursor-pointer border border-gray-200"
                >
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-gavel text-gray-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900" data-i18n="settings.legal.title">Rechtsinformationen</h3>
                                <p class="text-sm text-gray-500" data-i18n="settings.legal.subtitle">Datenexport, Account lÃ¶schen</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </a>

                <!-- Cache Reset (for PWA issues) -->
                <div
                    id="cache-reset-card"
                    class="settings-card block bg-white p-4 rounded-xl shadow-sm hover:shadow-md cursor-pointer border border-gray-200"
                >
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-sync-alt text-orange-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900">Cache zurÃ¼cksetzen</h3>
                                <p class="text-sm text-gray-500">Bei Anzeigeproblemen oder veralteten Daten</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </div>

                <!-- Logout Button -->
                <div class="pt-4">
                    <button
                        id="logout-button"
                        class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-xl shadow-md transition-transform transform hover:scale-[1.02] flex items-center justify-center gap-2"
                    >
                        <i class="fas fa-sign-out-alt"></i>
                        <span data-i18n="settings.logout">Abmelden</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Language Selection Modal -->
        <div id="language-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 transform transition-all">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-900" data-i18n="settings.language.select">Sprache auswÃ¤hlen</h2>
                    <button id="close-language-modal" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="space-y-3">
                    <button
                        class="language-option w-full flex items-center justify-between p-4 rounded-xl border-2 hover:bg-gray-50 transition-all"
                        data-lang="de"
                    >
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">ðŸ‡©ðŸ‡ª</span>
                            <span class="font-semibold text-gray-900" data-i18n="settings.language.german">Deutsch</span>
                        </div>
                        <i class="fas fa-check text-indigo-600 hidden check-icon"></i>
                    </button>
                    <button
                        class="language-option w-full flex items-center justify-between p-4 rounded-xl border-2 hover:bg-gray-50 transition-all"
                        data-lang="en"
                    >
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">ðŸ‡¬ðŸ‡§</span>
                            <span class="font-semibold text-gray-900" data-i18n="settings.language.english">English</span>
                        </div>
                        <i class="fas fa-check text-indigo-600 hidden check-icon"></i>
                    </button>
                    <button
                        class="language-option w-full flex items-center justify-between p-4 rounded-xl border-2 hover:bg-gray-50 transition-all"
                        data-lang="zh"
                    >
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">ðŸ‡¨ðŸ‡³</span>
                            <span class="font-semibold text-gray-900" data-i18n="settings.language.chinese">ç®€ä½“ä¸­æ–‡</span>
                        </div>
                        <i class="fas fa-check text-indigo-600 hidden check-icon"></i>
                    </button>
                </div>
            </div>
        </div>

        <script src="/js/update-checker.js"></script>
        <script src="/js/pwa-register.js"></script>
        <script type="module" src="/js/notifications.js"></script>
        <script type="module" src="/js/spa-enhancer.js"></script>
        <!-- Primary handlers: show content and attach click handlers immediately (no module dependency) -->
        <script>
            window.__settingsInitDone = false;

            // Show content immediately on DOMContentLoaded - don't wait for module
            document.addEventListener('DOMContentLoaded', function() {
                // Show content right away
                var loader = document.getElementById('page-loader');
                var content = document.getElementById('main-content');
                if (loader) loader.style.display = 'none';
                if (content) content.style.display = 'block';
                window.__settingsInitDone = true;
                if (window.hideSplash) window.hideSplash();

                // Language card â†’ open language modal
                var langCard = document.getElementById('language-card');
                var langModal = document.getElementById('language-modal');
                var closeLangBtn = document.getElementById('close-language-modal');
                if (langCard && langModal) {
                    langCard.addEventListener('click', function() {
                        langModal.classList.remove('hidden');
                        // Highlight current language
                        var currentLang = localStorage.getItem('app_language') || 'de';
                        document.querySelectorAll('.language-option').forEach(function(opt) {
                            var lang = opt.getAttribute('data-lang');
                            var check = opt.querySelector('.check-icon');
                            if (lang === currentLang) {
                                opt.classList.add('border-indigo-600', 'bg-indigo-50');
                                if (check) check.classList.remove('hidden');
                            } else {
                                opt.classList.remove('border-indigo-600', 'bg-indigo-50');
                                if (check) check.classList.add('hidden');
                            }
                        });
                    });
                }
                if (closeLangBtn && langModal) {
                    closeLangBtn.addEventListener('click', function() {
                        langModal.classList.add('hidden');
                    });
                    langModal.addEventListener('click', function(e) {
                        if (e.target === langModal) langModal.classList.add('hidden');
                    });
                }
                // Language option buttons - always save + reload
                document.querySelectorAll('.language-option').forEach(function(opt) {
                    opt.addEventListener('click', function() {
                        var lang = opt.getAttribute('data-lang');
                        localStorage.setItem('app_language', lang);
                        try {
                            if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.Preferences) {
                                window.Capacitor.Plugins.Preferences.set({ key: 'app_language', value: lang });
                            }
                        } catch(e) {}
                        window.location.reload();
                    });
                });

                // Logout button
                var logoutBtn = document.getElementById('logout-button');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', function() {
                        // Dynamic import for logout
                        import('/js/supabase-init.js').then(function(mod) {
                            var supabase = mod.getSupabase();
                            supabase.auth.signOut().then(function() {
                                window.location.href = '/index.html';
                            }).catch(function(err) {
                                console.error('Logout error:', err);
                                localStorage.clear();
                                window.location.href = '/index.html';
                            });
                        }).catch(function() {
                            localStorage.clear();
                            window.location.href = '/index.html';
                        });
                    });
                }
            });
        </script>
        <script type="module">
            import { getSupabase } from '/js/supabase-init.js';
            import { initI18n, changeLanguage, getCurrentLanguage, translatePage, setupAutoTranslate } from '/js/i18n.js';
            import { escapeHtml } from '/js/utils/security.js';

            // Check for child_id parameter (guardian viewing child's settings)
            const urlParams = new URLSearchParams(window.location.search);
            const childId = urlParams.get('child_id');
            let childProfile = null;

            // PrÃ¼ft ob Push-Benachrichtigungen unterstÃ¼tzt werden (PWA oder native App)
            function isPushSupported() {
                if (window.CapacitorUtils?.isNative()) return true;
                if (window.matchMedia('(display-mode: standalone)').matches) return true;
                if (window.navigator.standalone === true) return true;
                return false;
            }

            // Verify guardian has access to this child
            async function verifyGuardianAccess() {
                if (!childId) return true; // Not in child mode

                const supabase = getSupabase();
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return false;

                // Check if current user is guardian of this child
                const { data: guardianLink, error } = await supabase
                    .from('guardian_links')
                    .select('id, permissions')
                    .eq('guardian_id', user.id)
                    .eq('child_id', childId)
                    .single();

                if (error || !guardianLink) {
                    console.error('Guardian access denied:', error);
                    alert('Kein Zugriff auf die Einstellungen dieses Kindes.');
                    window.location.href = '/guardian-dashboard.html';
                    return false;
                }

                // Load child profile
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('id, first_name, last_name, avatar_url')
                    .eq('id', childId)
                    .single();

                if (profileError || !profile) {
                    console.error('Child profile not found:', profileError);
                    window.location.href = '/guardian-dashboard.html';
                    return false;
                }

                childProfile = profile;
                return true;
            }

            // Setup child mode UI
            function setupChildModeUI() {
                if (!childId || !childProfile) return;

                // Update page title and header
                const titleElement = document.querySelector('h1');
                if (titleElement) {
                    titleElement.textContent = `Einstellungen fÃ¼r ${childProfile.first_name}`;
                }
                document.title = `Einstellungen fÃ¼r ${childProfile.first_name} - SC Champions`;

                // Update back link to go to guardian dashboard
                const backLink = document.querySelector('a[href="/dashboard.html"]');
                if (backLink) {
                    backLink.href = '/guardian-dashboard.html';
                }

                // Update links to pass child_id parameter
                const profileLink = document.querySelector('a[href="/settings-profile.html"]');
                if (profileLink) {
                    profileLink.href = `/settings-profile.html?child_id=${childId}`;
                    // Update subtitle to show limited options
                    const subtitle = profileLink.querySelector('p.text-sm');
                    if (subtitle) {
                        subtitle.textContent = 'Name, Foto, PersÃ¶nliche Daten';
                    }
                }

                const privacyLink = document.querySelector('a[href="/settings-privacy.html"]');
                if (privacyLink) {
                    privacyLink.href = `/settings-privacy.html?child_id=${childId}`;
                }

                const clubLink = document.querySelector('a[href="/settings-club.html"]');
                if (clubLink) {
                    clubLink.href = `/settings-club.html?child_id=${childId}`;
                }

                const legalLink = document.querySelector('a[href="/settings-legal.html"]');
                if (legalLink) {
                    legalLink.href = `/settings-legal.html?child_id=${childId}`;
                }

                // Hide cards that guardians should NOT see for children:
                // - Notifications (not applicable for child)
                // - Meine Kinder (not applicable)
                // - Support (guardian can use their own)
                // - Language (should be their own setting)
                // - Cache reset (technical, not for children)
                // - Logout button (don't log out guardian)

                const elementsToHide = [
                    '#notifications-card',
                    '#my-children-card',
                    'a[href="/settings-support.html"]',
                    '#language-card',
                    '#cache-reset-card',
                    '#logout-button'
                ];

                elementsToHide.forEach(selector => {
                    const element = document.querySelector(selector);
                    if (element) {
                        // For logout button, hide the parent div too
                        if (selector === '#logout-button') {
                            element.parentElement?.classList.add('hidden');
                        } else {
                            element.classList.add('hidden');
                        }
                    }
                });
            }

            // Calculate age from birthdate
            function calculateAge(birthdate) {
                if (!birthdate) return 0;
                const birth = new Date(birthdate);
                const today = new Date();
                let age = today.getFullYear() - birth.getFullYear();
                const monthDiff = today.getMonth() - birth.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
                return age;
            }

            // Check if user is a guardian and show appropriate card
            async function checkGuardianStatus() {
                // Don't show "Meine Kinder" when already viewing child's settings
                if (childId) return;

                const supabase = getSupabase();
                const { data: { user } } = await supabase.auth.getUser();

                if (!user) return;

                try {
                    // Get profile and check is_guardian flag
                    const { data: profile, error } = await supabase
                        .from('profiles')
                        .select('is_guardian, account_type')
                        .eq('id', user.id)
                        .single();

                    if (error) {
                        console.error('Error checking guardian status:', error);
                        return;
                    }

                    const myChildrenCard = document.getElementById('my-children-card');
                    const myChildrenSubtitle = document.getElementById('my-children-subtitle');
                    const addChildCard = document.getElementById('add-child-card');

                    // Check if user has children that are minors
                    const isGuardian = profile?.is_guardian || profile?.account_type === 'guardian';

                    if (isGuardian) {
                        // Get children and check if any are under 18
                        const { data: children, error: childrenError } = await supabase.rpc('get_my_children');

                        if (!childrenError && children?.success && children.children && children.children.length > 0) {
                            // Filter children under 18
                            const childrenUnder18 = children.children.filter(child => {
                                if (!child.birthdate) return true; // If no birthdate, show to be safe
                                return calculateAge(child.birthdate) < 18;
                            });

                            // Only show "Meine Kinder" card if there are children under 18
                            if (childrenUnder18.length > 0) {
                                myChildrenCard?.classList.remove('hidden');
                                addChildCard?.classList.add('hidden');

                                if (childrenUnder18.length === 1) {
                                    myChildrenSubtitle.textContent = '1 Kind verknÃ¼pft';
                                } else {
                                    myChildrenSubtitle.textContent = `${childrenUnder18.length} Kinder verknÃ¼pft`;
                                }
                            } else {
                                // Guardian with children, but all are 18+ - show "Kind hinzufÃ¼gen" to add more
                                myChildrenCard?.classList.add('hidden');
                                addChildCard?.classList.remove('hidden');
                            }
                        } else {
                            // Guardian but no children - show "Kind hinzufÃ¼gen"
                            myChildrenCard?.classList.add('hidden');
                            addChildCard?.classList.remove('hidden');
                        }
                    } else {
                        // Not a guardian - show "Kind hinzufÃ¼gen" option
                        myChildrenCard?.classList.add('hidden');
                        addChildCard?.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Error in checkGuardianStatus:', error);
                }
            }

            // Module init: enhances the page with i18n translations and Supabase data
            // Content display and click handlers are already set up by the non-module script above
            async function init() {
                try {
                console.log('[Settings Module] init started');

                // If viewing child settings, verify access first
                if (childId) {
                    const hasAccess = await verifyGuardianAccess();
                    if (!hasAccess) return;
                }

                // Ensure content is visible (might already be from non-module script)
                document.getElementById('page-loader').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                window.__settingsInitDone = true;
                if (window.hideSplash) window.hideSplash();

                // Initialize i18n for translations (enhancement - page works without this)
                try {
                    await initI18n();
                    setupAutoTranslate();
                    translatePage();
                    document.documentElement.lang = getCurrentLanguage();
                    console.log('[Settings Module] i18n initialized');
                } catch (i18nError) {
                    console.warn('[Settings] i18n init failed, continuing without translations:', i18nError);
                }

                // Benachrichtigungen-Card nur in PWA/native anzeigen
                const notificationsCard = document.getElementById('notifications-card');
                if (notificationsCard && isPushSupported()) {
                    notificationsCard.classList.remove('hidden');
                }

                // Check guardian and coach status in parallel (non-blocking)
                const guardianPromise = checkGuardianStatus().catch(e => console.error('Guardian check failed:', e));
                const coachPromise = (async () => {
                    try {
                        const supabase = getSupabase();
                        const { data: { user } } = await supabase.auth.getUser();
                        if (user) {
                            const { data: profile } = await supabase
                                .from('profiles')
                                .select('role, club_id')
                                .eq('id', user.id)
                                .single();
                            const clubPageCard = document.getElementById('club-page-card');
                            if (clubPageCard && profile && (profile.role === 'coach' || profile.role === 'head_coach') && profile.club_id) {
                                clubPageCard.classList.remove('hidden');
                            }
                        }
                    } catch (e) {
                        console.error('Club page card check failed:', e);
                    }
                })();

                await Promise.all([guardianPromise, coachPromise]);

                // Setup child mode UI if viewing child's settings
                setupChildModeUI();

                // Cache reset functionality
                document.getElementById('cache-reset-card').addEventListener('click', async () => {
                    if (confirm('Cache und lokale Daten zurÃ¼cksetzen? Die App wird danach neu geladen.')) {
                        try {
                            // Clear localStorage (but preserve auth)
                            const authData = localStorage.getItem('sb-auth-token');
                            localStorage.clear();
                            if (authData) {
                                localStorage.setItem('sb-auth-token', authData);
                            }

                            // Clear all caches
                            if ('caches' in window) {
                                const cacheNames = await caches.keys();
                                await Promise.all(cacheNames.map(name => caches.delete(name)));
                            }

                            // Unregister service workers
                            if ('serviceWorker' in navigator) {
                                const registrations = await navigator.serviceWorker.getRegistrations();
                                await Promise.all(registrations.map(reg => reg.unregister()));
                            }

                            // Force reload
                            window.location.reload(true);
                        } catch (error) {
                            console.error('Cache reset error:', error);
                            alert('Fehler beim ZurÃ¼cksetzen: ' + error.message);
                        }
                    }
                });

                // Logout is handled by the non-module script above
                console.log('[Settings Module] init completed');
            } catch (err) {
                console.error('[Settings] Init error:', err);
                // Ensure content is visible even on error
                document.getElementById('page-loader').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                window.__settingsInitDone = true;
                if (window.hideSplash) window.hideSplash();
            }
            }

            // Initialize on DOMContentLoaded or immediately if already loaded (for SPA navigation)
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        </script>
    </body>
</html>
